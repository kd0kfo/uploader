{% extends "base.html" %}
{% block title %}Logon{% endblock %}
{% block content %}
<form action="logon.php" id="logonAction">
<label for="username">User Name:</label>
<input type="text" name="username" id="username"><br>
<label for="pass">Password:</label>
<input type="password" name="password" id="password"><br>
<label for="totp">One Time Passcode:</label>
<input type="text" name="totp" id="totp"><br>
<input type="hidden" name="salt" id="salt"/>
<input type="submit" name="submit" value="Submit">
</form>
<div id="result"></div>
<div id="footer"></div>
{% endblock %}
{% block pagescript %}
$("#footer").html(site_footer());
$("#logonAction").submit(function(event) {
	event.preventDefault();

	var form = $(this);
	var username = $("#username").val();
	var password = $("#password").val();
	var totp_token = $("#totp").val();
	var salt = $("#salt").val();
	var url = form.attr("action");

	var h = hash(username, password+salt);
	var logon_hash = hash("logon", h);
	var result = $.post(url, {username: username, hmac: logon_hash, totp: totp_token});

	result.done(function(data) {
		display_json_message(data);
		var json = $.parseJSON(data);
		if(json.sessionkey) {
			localStorage['username'] = username;
			localStorage['sessionkey'] = hash(h + json.sessionkey, h);
		}
	});
	result.fail(function(jqXHR) {
		display_json_message(jqXHR.responseText);
	});


});
$(document).ready(function() {
	var server_info = get_server_info();
	if(server_info['salt']) {
		$("#salt").val(server_info['salt']);
	}
	if(server_info['time']) {
		localStorage['offset'] = server_info['time'] - unixtime();
	}
});
{% endblock %}
